---
title: "Clustering Methods"
author: "Mary Solomon"
date: "2/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(stringr)
library(scales) #for formatting with percentage signs
library(nnet) #for multinomial regression
```


Read data
```{r}
data <- fread("kpopdata.csv")
colnames(data)
```


# Clustering (unsupervised)
```{r}
mode1 <- data %>% 
  dplyr::filter(mode == 1) %>%
  dplyr::select(popularity, duration, acousticness, danceability, energy, 
         instrumentalness, key, loudness, speechiness, tempo, valence)
mode0 <- data %>% 
  dplyr::filter(mode == 0) %>%
  dplyr::select(popularity, duration, acousticness, danceability, energy, 
         instrumentalness, key, loudness, speechiness, tempo, valence)
```
The previous section aims to determine what kind of model we can build in order to predict which generation a kpop song is from based on audio/song features alone. However, could there be an alternative way to group the songs in the kpop genre based on audio/song features? Kpop Generations are grouped by the time and evolution of the kpop genre. By excluding time period, cultural trends, catchy visuals, dances, and only focusing on the audio features of the songs, what will the groups be defined by and how will it differ from the characteristics of the kpop generations observed in previous chapters?

Before we can start clustering, we will perform dimension reduction which will reduce allow us to analyze the data on fewer dimensions yet retain as much accountability for the variation as possible.
## Dimension Reduction: PCA ##

PCA is a dimension reduction technique that defines uncorrelated linear combinations that maximize the variance. Or in otherwords, PCA reduces the dimensions by with linear combinations that maximizes the information explained by the data. The assumptions made to perform PCA dimension reduction are as follows:      

* No assumption on the distribution: this is very good because the majority of the predictors have non-normal skewed distributions       

* No indpendence to be assumed for elements in a random vector: aka colinearity can exist between variables (???)     

* Assume independence between observations in the random sample: this is a fair assumption to make. Each song is composed independently from one another, for the most part.   

* most appropriate for continuous data: this could be a potential issue since there are categorical variables such as key, mode, time signature. While numeric, they are integer values that span a small range. Because of this, we will be analyzing the dimension reduction separately for those with a minor mode versus those with major mode. In addition, time signature will be removed from the analysis since 97% of the songs are detected as being in 4/4 time.

#### PCA for Major mode (mode = 1)

standardized PCA
```{r}
pca1 <- prcomp(mode1, scale=TRUE)
t(pca1$rotation)
```

For clearer interpretation, we can express the principal components as linear combinations of the standardized value of each variable. The first 6 PCs are expressed below rounded to 3 decimals: 

$$
\hat y_1 = -0.087z_{Popularity} + 0.234z_{Duration} + 0.427z_{Acousticness} - 0.330z_{Danceability} -0.502z_{Energy} + 0.089z_{Instrumantalness} + 0.045z_{Key} - 0.420z_{Loudness} - 0.178z_{speechiness} -0.066z_{tempo} - 0.415z_{valence} 
\\
\hat y_2 = 0.335z_{Popularity} + 0.113z_{Duration} - 0.020z_{Acousticness} -0.516z_{Danceability} + 0.131z_{Energy} -0.259z_{Instrumantalness} + 0.066z_{Key} + 0.269z_{Loudness} + 0.200z_{speechiness} + 0.577z_{tempo} -0.274z_{valence}
\\
\hat y_3 = -0.545z_{Popularity} + 0.562z_{Duration} - 0.223z_{Acousticness} -0.129z_{Danceability} + 0.209z_{Energy} - 0.071z_{Instrumantalness} - 0.172z_{Key} +  0.185z_{Loudness} -0.446z_{speechiness} + 0.095z_{tempo} +0.005z_{valence}
\\
\hat y_4 = 0.367z_{Popularity} + 0.183z_{Duration} + 0.106z_{Acousticness} + 0.147z_{Danceability} -0.043z_{Energy} -0.632z_{Instrumantalness} + 0.230z_{Key} + 0.222z_{Loudness} -0.323z_{speechiness} - 0.433z_{tempo} -0.058z_{valence}
\\
\hat y_5 = 0.139z_{Popularity} + 0.014z_{Duration} + 0.077z_{Acousticness} + 0.036z_{Danceability} -0.086z_{Energy} -0.266z_{Instrumantalness} -0.934z_{Key}  -0.056z_{Loudness} + 0.124z_{speechiness} -0.064z_{tempo} -0.011z_{valence}
$$

INTERPRETATION OF THE PCs:     

* PC1: this Principal component has the variables of duration, acousticness, instrumentalness and key grouped in the positive direction against the variables of Popularity, danceability, energy, loudness, speechiness, tempo and valence which are contributing in the negative direction. The variables that have negative loading factors seem to be variables that are characteristics which would determine if a song is very upbeat and achieves mainstream appeal of pop music to be an exciting song that you can dance and move to.  The factors with the greater loadings are Energy at -0.502, loudness at -0.420, valence at -0.415, and acousticness at 0.427.

* PC2: Here, the positive loading factors are associated with standardized scores for popularity, duration, energy, key loudness, speechiness and tempo. Where tempo has the greatest loading factor at 0.577, therefore accounting for the most variation. Whereas the negative direction loading values are coefficients for variables of Acousticness, danceability, instrumentalness and valence. For the negative direction standardized variables, Danceability has the largest negative coefficient of -0.516.

* PC3: The positive standardized variables are Duration, Energy, Loudness, Tempo and Valence. Duration has the highest factor in comparison with the others at a loading factor of 0.562. For the Negative direction, we have variables of Popularity, Acousticness, Danceability, instrumentalness, Key, and speechiness, where Popularity and Speechiness have the greatest negative weight at -0.545 and -0.446 respectively.     

* PC4: The variable that is weighted with the most variation in this component is instrumentalness with a loading factor of -0.632. Other variables weighted in the negative direction are tempo with the second largest loading factor at -0.433, speechiness, valence and energy. In the positive direction, we have popularity, duration, acousticness, danceability,, Key and Loudness, which are more equally weighted than the variables with negative loading factors.

* PC5: When interpreting the 5th component, one attribute stands out. The loading factor for standardized variable of Key accounts for almost all of the variation in this principal component with a loading factor of -0.934. Therefore, the 5th component serves to characterize the musical key of the song.



biplot
```{r}
biplot(pca1, scale = 0, xlabs=rep("·", nrow(mode1)))
```


examine amount of variance explained to choose optimal principal components
```{r}
pca1.var = pca1$sdev^2
pve1 = pca1.var/sum(pca1.var)
cve1 = cumsum(pve1)
pca1.var.explained <- data.frame("Variance" = pca1.var, 
                                "Proportion_Variation" = pve1, 
                                "Cummalitve_Proportion_Variation"= cve1, 
                                "PC" = factor(c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7",
                                         "PC8", "PC9", "PC10", "PC11"), 
                                         levels = c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7",
                                         "PC8", "PC9", "PC10", "PC11")))
pca1.var.explained
```



```{r}
pca1.var.explained %>%
  ggplot(aes(x=PC,y=Proportion_Variation, group=1))+
  ylab("Proportion of Variance Explained") +
  geom_point(size=3)+
  geom_line()+
  labs(title="Scree plot: PCA on scaled data") +
  theme_minimal()
```





#### PCA for minor mode (mode = 0)

standardized PCA
```{r}
pca0 <- prcomp(mode0, scale=TRUE)
t(pca0$rotation)
```




$$
\hat y_1 = 0.040z_{Popularity} - 0.138z_{Duration} - 0.440z_{Acousticness} + 0.224z_{Danceability} + 0.554z_{Energy} -0.114z_{Instrumantalness} + 0.069z_{Key} + 0.472z_{Loudness} + 0.117z_{speechiness} + 0.105z_{tempo} + 0.404z_{valence} 
\\
\hat y_2 = -0.293z_{Popularity} -0.096z_{Duration} -0.005z_{Acousticness} + 0.625z_{Danceability} -0.151z_{Energy} + 0.126z_{Instrumantalness} + 0.118z_{Key}  -0.266z_{Loudness} -0.252z_{speechiness} -0.440z_{tempo} + 0.365z_{valence}
\\
\hat y_3 = 0.645z_{Popularity} -0.466z_{Duration} + 0.229z_{Acousticness} +0.177z_{Danceability} -0.157z_{Energy} -0.3451z_{Instrumantalness} -0.122z_{Key} +  0.142z_{Loudness} +0.070z_{speechiness} -0.314z_{tempo} -0.038z_{valence}
\\
\hat y_4 = -0.020z_{Popularity} + 0.548z_{Duration} -0.009z_{Acousticness} -0.035z_{Danceability} + 0.076z_{Energy} -0.482z_{Instrumantalness} -0.198z_{Key} + 0.255z_{Loudness} -0.508z_{speechiness} -0.302z_{tempo} -0.081z_{valence}
\\
\hat y_5 = -0.056z_{Popularity} +0.196z_{Duration} + 0.076z_{Acousticness} -0.007z_{Danceability}  -0.076z_{Energy} -0.458z_{Instrumantalness} +0.781z_{Key}  -0.065z_{Loudness} + 0.343z_{speechiness} -0.071z_{tempo} -0.005z_{valence}
$$


INTERPRETATION OF THE PCs:     

* PC1: The variables with positive direction coefficients are: Energy, Loudness, Valence, Danceability, Speechiness, Tempo, and Popularity, with Energy, Loudness and Valence having the greatest weights, therefore accounting for the majoiryt of the variation in the positive direction. The negative weighted variables are Acousticness, Duration and Instrumentalness where Acousticness has the highest weight. The variables with the positive direction weights are ones that an average person would assume to be associated with fun, upbeat, pop hits as opposed to the variables that are weighted in the negative direction. A fun observation to point out is the contrast to the songs with mode = 1. Notice how there are similar groupings of variables, but with the signs flipped. This shows that songs that are in a minor key (mode = 0) experience opposite direction for similar groupings as major and minor key songs tend to give off opposite moods/tones from one another musically. 

* PC2: Variables weighted in the positive direction are: Danceability, Valence, Instrumentallness,and KEy, with Danceability being weighted the most heavily at 0.625. The variables weighted in the negative direction are: Tempo, Popularity, Loudness, Speechiness,Energy, Duraiton and Acousticness with Tempo holding the greatest negative weight.

* PC3: For this PC, Popularity is weighted very heavily in the positive direction compared to other variables such as Acousticness, Danceability, loudness, and speechiness. In the negative direction there is Duration, Instrumentalness, Tempo and Valence, where all variables except valence are weighted fairly equally in the negative direction. 

* PC4: In the positive direction, Duration is weighted the most at 0.548, followed by Loudness, at 0.255 and Energy with a loading factor of just 0.076 and Valence at 0.038 in the negative direction, Speechiness carreies the most weight at -0.508, followed by Instrumentalness at -0.482, then Tempo, Key, Valence, Danceability, Popularity and Acousticness.

* PC5: Similar to the 5th pc of songs with mode of 1, this component has Key as the variabl that accounts for the largest amount of variation in the data due to the highest loading factor of 0.781. The next significant weight is in the negative direction: -0.458 for the variable of Instrumentalness. Therefore, this PC serves to capture the characteristics of the instrumentation and its musical quality (key).



biplot
```{r}
biplot(pca0, scale = 0, xlabs=rep("·", nrow(mode0)))
```


examine amount of variance explained to choose optimal principal components
```{r}
pca0.var = pca0$sdev^2
pve0 = pca0.var/sum(pca0.var)
cve0 = cumsum(pve0)
pca0.var.explained <- data.frame("Variance" = pca0.var, 
                                "Proportion_Variation" = pve0, 
                                "Cummalitve_Proportion_Variation"= cve0, 
                                "PC" = factor(c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7",
                                         "PC8", "PC9", "PC10", "PC11"), 
                                         levels = c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7",
                                         "PC8", "PC9", "PC10", "PC11")))
pca0.var.explained
```



```{r}
pca0.var.explained %>%
  ggplot(aes(x=PC,y=Proportion_Variation, group=1))+
  ylab("Proportion of Variance Explained") +
  geom_point(size=3)+
  geom_line()+
  labs(title="Scree plot: PCA on scaled data") +
  theme_minimal()
```




## Clustering on PCA: Kmeans clustering ##
 
### for songs where mode = 0
Choosing number of groups (K) via elbow method
```{r}
pc0_1to5 <- data.frame(pca0$x[,1:5])
set.seed(123)
#compute total within cluster sum of square
wss <- function(k) {
  kmeans(pc0_1to5, k, iter.max = 1000, nstart = 25, algorithm = "Hartigan-Wong")$tot.withinss
}
k.vals <- 1:15
wss_values <- map_dbl(k.vals, wss)

plot(k.vals, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

silhouette method
```{r}
library(factoextra)
fviz_nbclust(pc0_1to5, kmeans, method="silhouette")
```


visualize the two clusters
```{r}
set.seed(123)
k <- kmeans(pc0_1to5, 2, iter.max = 1000, nstart = 25, algorithm = "Hartigan-Wong")
pc0_1to5$clusters <- as.factor(k$cluster)
ggplot(pc0_1to5, aes(PC1, PC2, color = clusters)) + geom_point() + 
  labs(title = "K-means Cluster on Principal Components", x = "PC1", y = "PC2") +
  theme_bw()
```

### for songs where mode = 1
Choosing number of groups (K) via elbow method
```{r}
pc1_1to5 <- data.frame(pca1$x[,1:5])
set.seed(123)
#compute total within cluster sum of square
wss <- function(k) {
  kmeans(pc1_1to5, k, iter.max = 1000, nstart = 25, algorithm = "Hartigan-Wong")$tot.withinss
}
k.vals <- 1:15
wss_values <- map_dbl(k.vals, wss)

plot(k.vals, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
```

silhouette method
```{r}
fviz_nbclust(pc1_1to5, kmeans, method="silhouette")
```

```{r}
set.seed(123)
k <- kmeans(pc1_1to5, 2, iter.max = 1000, nstart = 25, algorithm = "Hartigan-Wong")
pc1_1to5$clusters <- as.factor(k$cluster)
ggplot(pc1_1to5, aes(PC1, PC2, color = clusters)) + geom_point() + 
  labs(title = "K-means Cluster on Principal Components", x = "PC1", y = "PC2") +
  theme_bw()
```

## Heirarchical Clustering: Ward's method ##

```{r}
mode0.st <- scale(mode0)
mode1.st <- scale(mode1)

```


column means and covariates of songs with mode == 0
```{r}
colMeans(mode0.st);cov(mode0.st)
```


column means and covariates of songs with mode == 1
```{r}
colMeans(mode1.st);cov(mode1.st)
```



No issues of multicollinearity in either subset.

### Ward's Method: Mode 0

```{r}
mode0.d <- dist(mode0.st, method = "euclidean")
mode0_ward <- hclust(mode0.d, method = "ward.D2")
plot(mode0_ward)
```

The largest distance from the first cluster can be observed on the left side where the height has a distance of about 30. Therefore, Ward's method groups the dataset into 3 clusters. 

```{r}
plot(mode0_ward)
rect.hclust(mode0_ward, k=3, border="red")
```


We can see that there is one large cluster to the left, a very small amount of songs in the second cluster and about 1/5 of the songs in the 3rd cluster. Lets see exactly how many songs are assigned to each cluster:
```{r}
mode0.groups <- cutree(mode0_ward, k=3)
table(mode0.groups)
table(mode0.groups)/nrow(mode0)
```



### Ward's Method: Mode 1

```{r}
mode1.d <- dist(mode1.st, method = "euclidean")
mode1_ward <- hclust(mode1.d, method = "ward.D2")
plot(mode1_ward)
```

Similarly to the songs where mode = 0, Ward's heirarchical method clusters the music into 3 separate groups. In addition, the 2nd group is also extremely small compared to the rest of the music.


```{r}
plot(mode1_ward)
rect.hclust(mode1_ward, k=3, border="red")
```


```{r}
mode1.groups <- cutree(mode1_ward, k=3)
table(mode1.groups)
table(mode1.groups)/nrow(mode1)
```



